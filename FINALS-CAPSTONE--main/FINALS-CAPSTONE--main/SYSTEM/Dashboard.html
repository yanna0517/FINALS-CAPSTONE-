<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sales & Inventory Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Alfa+Slab+One&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }
    .font-alfa { font-family: 'Alfa Slab One', cursive; text-shadow: 1px 1px 1px rgba(0,0,0,0.1); }
    .sidebar-link.active { background-color: #e5e7eb; color: #1f2937; }
    .sidebar-link.active svg { color: #719cd8; }
    .card-number { font-size: 1.5rem; font-weight: 700; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="flex h-full min-h-screen">
    <!-- Sidebar (UNCHANGED) -->
    <aside class="w-64 bg-white flex flex-col border-r flex-shrink-0">
      <div class="h-20 flex items-center justify-center bg-white border-b">
        <h1 class="font-alfa text-4xl tracking-wider">AUG DEPT.</h1>
      </div>
      <nav class="flex-1 px-4 py-6 space-y-2">
        <a href="Dashboard.html" class="sidebar-link active flex items-center text-gray-600 hover:bg-gray-200 py-2.5 px-4 rounded-lg transition duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
          Dashboard
        </a>
        <a href="Sales.html" class="sidebar-link flex items-center text-gray-600 hover:bg-gray-200 py-2.5 px-4 rounded-lg transition duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
          Sales
        </a>
        <a href="Inventory.html" class="sidebar-link flex items-center text-gray-600 hover:bg-gray-200 py-2.5 px-4 rounded-lg transition duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
          Inventory
        </a>

        <a href="#" class="sidebar-link flex items-center text-gray-600 hover:bg-gray-200 py-2.5 px-4 rounded-lg transition duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2a4 4 0 00-4-4H3a2 2 0 00-2 2v6a2 2 0 002 2h2a4 4 0 004-4zm0 0v-2a4 4 0 014-4h2a4 4 0 014 4v2m-6 4h6m-6-4v6m0-6H9" /></svg>
          Reports
        </a>

        <a href="#" class="sidebar-link flex items-center text-gray-600 hover:bg-gray-200 py-2.5 px-4 rounded-lg transition duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
          Notifications
        </a>

        <a href="#" class="sidebar-link flex items-center text-gray-600 hover:bg-gray-200 py-2.5 px-4 rounded-lg transition duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
          Settings (Admin only)
        </a>

        <a href="#" class="sidebar-link flex items-center text-gray-600 hover:bg-gray-200 py-2.5 px-4 rounded-lg transition duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
          User Management (Admin only)
        </a>
      </nav>

      <div class="px-4 py-6 border-t border-gray-200">
        <a href="#" class="sidebar-link flex items-center text-gray-600 hover:bg-gray-200 py-2.5 px-4 rounded-lg transition duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
          Logout
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8 overflow-y-auto bg-gray-50">
      <div class="flex items-start justify-between mb-6">
        <h1 class="text-3xl font-bold">Dashboard</h1>
        <div class="flex items-center gap-3">
          <button id="refreshBtn" class="px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm hover:bg-gray-50">Refresh</button>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
        <div class="bg-white p-5 rounded-lg border border-gray-200">
          <div class="text-sm text-gray-500">Total Sales (₱)</div>
          <div id="cardTotalSales" class="card-number text-gray-800 mt-2">₱0.00</div>
          <div class="text-xs text-gray-400 mt-1">Total revenue from sales</div>
        </div>

        <div class="bg-white p-5 rounded-lg border border-gray-200">
          <div class="text-sm text-gray-500">Transactions</div>
          <div id="cardTransactions" class="card-number text-gray-800 mt-2">0</div>
          <div class="text-xs text-gray-400 mt-1">Number of sales records</div>
        </div>

        <div class="bg-white p-5 rounded-lg border border-gray-200">
          <div class="text-sm text-gray-500">Inventory Items</div>
          <div id="cardInventoryItems" class="card-number text-gray-800 mt-2">0</div>
          <div class="text-xs text-gray-400 mt-1">Unique inventory entries</div>
        </div>

        <div class="bg-white p-5 rounded-lg border border-gray-200">
          <div class="text-sm text-gray-500">Total Stock Quantity</div>
          <div id="cardStockQty" class="card-number text-gray-800 mt-2">0</div>
          <div class="text-xs text-gray-400 mt-1">Sum of all inventory quantities</div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Recent Sales + Low Stock column -->
        <div class="lg:col-span-1 space-y-6">
          <div class="bg-white p-6 rounded-lg border border-gray-200">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold">Recent Sales</h3>
              <button id="viewAllSales" class="text-sm text-blue-600 hover:underline">View all</button>
            </div>

            <div id="recentSalesList" class="space-y-3 text-sm text-gray-700">
              <div id="recentEmpty" class="text-gray-500">No sales yet.</div>
              <!-- recent entries injected here -->
            </div>
          </div>

          <div class="bg-white p-6 rounded-lg border border-gray-200">
            <h3 class="text-lg font-semibold mb-3">Low Stock Alerts</h3>
            <div id="lowStockList" class="text-sm text-gray-700">
              <div id="lowStockEmpty" class="text-gray-500">No low stock items.</div>
              <!-- low stock items injected here -->
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="lg:col-span-2 space-y-6">
          <div class="bg-white p-6 rounded-lg border border-gray-200">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-lg font-semibold">Sales by Product (₱)</h3>
              <div class="text-sm text-gray-500">Aggregated revenue per product</div>
            </div>
            <canvas id="chartSalesAmount" height="140"></canvas>
          </div>

          <div class="bg-white p-6 rounded-lg border border-gray-200">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-lg font-semibold">Quantity Sold by Product</h3>
              <div class="text-sm text-gray-500">Total units sold per product</div>
            </div>
            <canvas id="chartSalesQty" height="140"></canvas>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    /***************************
     * Dashboard: localStorage-driven
     * Expects:
     * - localStorage.salesData -> JSON array of { datetime, product, qty, total }
     * - localStorage.inventoryData -> JSON array of { product, category, quantity, total }
     *
     * If keys are missing, the dashboard shows empty states.
     ***************************/

    // Config: product list (keeps consistent ordering for charts)
    const PRODUCT_KEYS = ['shirts','cap','umbrella','perfume'];
    const PRODUCT_LABELS = { shirts: 'Shirts', cap: 'Cap', umbrella: 'Umbrella', perfume: 'Perfume' };

    // DOM refs
    const cardTotalSales = document.getElementById('cardTotalSales');
    const cardTransactions = document.getElementById('cardTransactions');
    const cardInventoryItems = document.getElementById('cardInventoryItems');
    const cardStockQty = document.getElementById('cardStockQty');

    const recentSalesList = document.getElementById('recentSalesList');
    const recentEmpty = document.getElementById('recentEmpty');

    const lowStockList = document.getElementById('lowStockList');
    const lowStockEmpty = document.getElementById('lowStockEmpty');

    const refreshBtn = document.getElementById('refreshBtn');
    const viewAllSales = document.getElementById('viewAllSales');

    // Charts
    let chartAmount = null;
    let chartQty = null;

    // Read data from localStorage (safe parsing)
    function readSalesData() {
      try {
        const raw = localStorage.getItem('salesData');
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        // normalize objects: ensure fields
        return parsed.map(s => ({
          datetime: s.datetime || s.date || formatDate(new Date()),
          product: (s.product || '').toString().toLowerCase(),
          qty: Number(s.qty || s.quantity || 0),
          total: Number(s.total || 0)
        }));
      } catch (e) {
        console.warn('Failed to parse salesData from localStorage', e);
        return [];
      }
    }

    function readInventoryData() {
      try {
        const raw = localStorage.getItem('inventoryData');
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed.map(i => ({
          product: (i.product || '').toString().toLowerCase(),
          category: (i.category || '').toString().toLowerCase(),
          quantity: Number(i.quantity || i.qty || 0),
          total: Number(i.total || 0)
        }));
      } catch (e) {
        console.warn('Failed to parse inventoryData from localStorage', e);
        return [];
      }
    }

    // Format helpers
    function formatCurrency(n) {
      return '₱' + Number(n || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function formatDate(date) {
      // fallback format: Month DD, YYYY - HH:mm AM/PM (matches Sales)
      const d = new Date(date);
      if (isNaN(d)) return '';
      const options = { year: 'numeric', month: 'long', day: '2-digit' };
      const datePart = new Intl.DateTimeFormat('en-US', options).format(d);
      let hours = d.getHours();
      const minutes = String(d.getMinutes()).padStart(2,'0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12; hours = hours ? hours : 12;
      return `${datePart} - ${hours}:${minutes} ${ampm}`;
    }

    function capitalize(s) {
      if (!s) return '';
      return s.charAt(0).toUpperCase() + s.slice(1);
    }

    // Build dashboard from data
    function updateDashboard() {
      const sales = readSalesData();
      const inventory = readInventoryData();

      // Summaries
      const totalSalesAmount = sales.reduce((sum, s) => sum + Number(s.total || 0), 0);
      cardTotalSales.textContent = formatCurrency(totalSalesAmount);

      cardTransactions.textContent = sales.length;

      cardInventoryItems.textContent = inventory.length;
      const totalStockQty = inventory.reduce((sum, it) => sum + Number(it.quantity || 0), 0);
      cardStockQty.textContent = totalStockQty;

      // Recent Sales (last 5)
      recentSalesList.querySelectorAll('.recent-row').forEach(n => n.remove());
      const recent = sales.slice(-5).reverse(); // last 5, newest first
      if (recent.length === 0) {
        recentEmpty.style.display = '';
      } else {
        recentEmpty.style.display = 'none';
        recent.forEach(s => {
          const el = document.createElement('div');
          el.className = 'recent-row flex items-center justify-between';
          el.innerHTML = `
            <div>
              <div class="text-sm font-medium">${capitalize(s.product)}</div>
              <div class="text-xs text-gray-400">${escapeHtml(s.datetime)}</div>
            </div>
            <div class="text-sm text-gray-700">
              <div>${s.qty} pcs</div>
              <div class="text-gray-500 text-xs">${formatCurrency(s.total)}</div>
            </div>
          `;
          recentSalesList.appendChild(el);
        });
      }

      // Low stock alerts (quantity < 5)
      lowStockList.querySelectorAll('.low-row').forEach(n => n.remove());
      const low = inventory.filter(it => Number(it.quantity || 0) < 5);
      if (low.length === 0) {
        lowStockEmpty.style.display = '';
      } else {
        lowStockEmpty.style.display = 'none';
        low.forEach(it => {
          const el = document.createElement('div');
          el.className = 'low-row flex items-center justify-between py-2 border-b last:border-b-0';
          el.innerHTML = `
            <div class="text-sm">
              <div class="font-medium">${capitalize(it.product)}</div>
              <div class="text-xs text-gray-500">${capitalize(it.category || '')}</div>
            </div>
            <div class="text-sm text-red-600 font-semibold">${it.quantity}</div>
          `;
          lowStockList.appendChild(el);
        });
      }

      // Charts: aggregate data by product keys
      const amountByProduct = {};
      const qtyByProduct = {};
      PRODUCT_KEYS.forEach(k => { amountByProduct[k] = 0; qtyByProduct[k] = 0; });

      sales.forEach(s => {
        const p = (s.product || '').toLowerCase();
        if (!PRODUCT_KEYS.includes(p)) {
          // include unknown products dynamically
          if (!(p in amountByProduct)) { amountByProduct[p] = 0; qtyByProduct[p] = 0; }
        }
        amountByProduct[p] = (amountByProduct[p] || 0) + Number(s.total || 0);
        qtyByProduct[p] = (qtyByProduct[p] || 0) + Number(s.qty || 0);
      });

      // Prepare labels (include any dynamic product keys)
      const productKeysAll = Array.from(new Set([...PRODUCT_KEYS, ...Object.keys(amountByProduct)]));
      const labels = productKeysAll.map(k => PRODUCT_LABELS[k] || capitalize(k));

      const amounts = productKeysAll.map(k => Number(amountByProduct[k] || 0));
      const qtys = productKeysAll.map(k => Number(qtyByProduct[k] || 0));

      renderOrUpdateChart('chartSalesAmount', chartAmount, labels, amounts, '₱', (chartRef) => chartAmount = chartRef, 'rgba(59,130,246,0.7)');
      renderOrUpdateChart('chartSalesQty', chartQty, labels, qtys, '', (chartRef) => chartQty = chartRef, 'rgba(16,185,129,0.7)');

    }

    // Create or update Chart.js bar chart
    function renderOrUpdateChart(canvasId, existingChart, labels, data, prefix='', storeRefCallback=()=>{}, color='rgba(59,130,246,0.7)') {
      const ctx = document.getElementById(canvasId).getContext('2d');
      if (existingChart) {
        existingChart.data.labels = labels;
        existingChart.data.datasets[0].data = data;
        existingChart.update();
        storeRefCallback(existingChart);
        return;
      }

      const newChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: prefix ? `${prefix} per product` : `Count`,
            data: data,
            backgroundColor: labels.map(() => color),
            borderRadius: 6,
            barPercentage: 0.6,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const val = context.parsed.y;
                  return prefix ? `${prefix}${Number(val).toLocaleString()}` : `${Number(val).toLocaleString()}`;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: { maxRotation: 0, autoSkip: false }
            },
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(v) {
                  return prefix ? `${prefix}${v}` : v;
                }
              }
            }
          }
        }
      });

      storeRefCallback(newChart);
    }

    // Utilities
    function escapeHtml(unsafe) {
      return String(unsafe || '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');
    }

    // Bind UI
    refreshBtn.addEventListener('click', updateDashboard);
    viewAllSales.addEventListener('click', () => {
      // open Sales page in same tab
      window.location.href = 'Sales.html';
    });

    // auto refresh every 5 seconds to pick up changes made from other pages/scripts
    let _refreshInterval = setInterval(updateDashboard, 5000);

    // Listen for storage events so cross-tab updates reflect immediately
    window.addEventListener('storage', (e) => {
      if (e.key === 'salesData' || e.key === 'inventoryData' || e.key === null) {
        updateDashboard();
      }
    });

    // initialize
    (function init() {
      updateDashboard();
    })();
  </script>
</body>
</html>
